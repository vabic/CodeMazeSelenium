version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: setup dotnet
    task:
      jobs:
        - name: Checkout code
          commands:
            - dotnet publish -c Release -o output EmployeesApp/EmployeesApp.sln
            - cache store dotnet-cache ./output
            - cd output/
            - dotnet vstest EmployeesApp.Tests.dll
            - dotnet vstest EmployeesApp.IntegrationTests.dll
            - cache has_key dotnet-cache
      prologue:
        commands:
          - checkout
          - sudo snap install dotnet-sdk --classic
          - sudo snap install dotnet-runtime-31
          - sudo snap alias dotnet-sdk.dotnet dotnet
    dependencies: []
  - name: Build project
    dependencies:
      - setup dotnet
    task:
      jobs:
        - name: Unit Test
          commands:
            - dotnet --version
            - dotnet --list-sdks
            - dotnet --list-runtimes
            - 'ls -al '
            - dotnet vstest EmployeesApp.Tests.dll
        - name: Integration test
          commands:
            - dotnet --version
            - dotnet --list-sdks
            - dotnet --list-runtimes
            - ls -al
            - dotnet vstest EmployeesApp.IntegrationTests.dll
      prologue:
        commands:
          - cache restore dotnet-cache
          - sudo snap install dotnet-sdk --classic
          - sudo snap install dotnet-runtime-31
          - sudo snap alias dotnet-sdk.dotnet dotnet
  - name: 'Block #3'
    dependencies:
      - Build project
    task:
      jobs:
        - name: 'Job #1'
          commands:
            - cd output
            - dotnet vstest EmployeesApp.Tests.dll
        - name: 'Job #2'
          commands:
            - dotnet vstest EmployeesApp.IntegrationTests.dll
        - name: 'Check docker '
          commands:
            - cd EmployeesApp/EmployeesApp
            - docker-compose ps
