version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: setup dotnet
    task:
      jobs:
        - name: Checkout code
          commands:
            - checkout
            - echo pwd
        - name: Install dotnet and cahce
          commands:
            - cache restore dotnet_cache
            - sudo snap install dotnet-sdk --classic
            - sudo snap install dotnet-runtime-31
            - sudo snap alias dotnet-sdk.dotnet dotnet
            - cache store dotnet_cache
            - dotnet --version
            - dotnet --list-sdks
            - dotnet --list-runtimes
        - name: check dotnet version
          commands:
            - 'cache restore '
            - dotnet --version
            - dotnet --list-sdks
            - dotnet --list-runtimes
      prologue:
        commands:
          - cache restore dotnet-cache
      epilogue:
        always:
          commands:
            - cache store dotnet-cache
    dependencies: []
  - name: Build project
    dependencies:
      - setup dotnet
    task:
      jobs:
        - name: Restore
          commands:
            - checkout
            - dotnet restore EmployeesApp/EmployeesApp.sln
            - dotnet publish -c Release -o output EmployeesApp/Employe
        - name: docker up
          commands:
            - cd EmployeesApp/EmployeesApp
            - docker-compose build
            - docker-compose up -d
      prologue:
        commands:
          - cache restore dotnet-cache
  - name: 'Block #3'
    dependencies:
      - Build project
    task:
      jobs:
        - name: 'Job #1'
          commands:
            - cd output
            - dotnet vstest EmployeesApp.Tests.dll
        - name: 'Job #2'
          commands:
            - dotnet vstest EmployeesApp.IntegrationTests.dll
        - name: 'Check docker '
          commands:
            - cd EmployeesApp/EmployeesApp
            - docker-compose ps
