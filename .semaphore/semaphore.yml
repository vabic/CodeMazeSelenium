version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: setup dotnet
    task:
      jobs:
        - name: Checkout code
          commands:
            - dotnet publish -c Release -o output EmployeesApp/EmployeesApp.sln
            - cache store dotnet-cache ./output
            - cd output/
            - dotnet vstest EmployeesApp.Tests.dll
            - dotnet vstest EmployeesApp.IntegrationTests.dll
            - cache has_key dotnet-cache
      prologue:
        commands:
          - checkout
          - sudo snap install dotnet-sdk --classic
          - sudo snap install dotnet-runtime-31
          - sudo snap alias dotnet-sdk.dotnet dotnet
    dependencies: []
  - name: Build project
    dependencies:
      - setup dotnet
    task:
      jobs:
        - name: Unit Test
          commands:
            - cache restore dotnet-cache
            - dotnet vstest EmployeesApp.Tests.dll
        - name: Integration test
          commands:
            - '# besoin du code source pour rouller'
            - checkout
            - mkdir output
            - cd output
            - cache restore dotnet-cache
            - dotnet vstest EmployeesApp.IntegrationTests.dll
      prologue:
        commands:
          - sudo snap install dotnet-sdk --classic
          - sudo snap install dotnet-runtime-31
          - sudo snap alias dotnet-sdk.dotnet dotnet
  - name: 'Block #3'
    dependencies:
      - setup dotnet
    task:
      jobs:
        - name: 'Check docker '
          commands:
            - cd ~/$SEMAPHORE_PROJECT_NAME/EmployeesApp/EmployeesApp
            - docker-compose up -d
            - docker-compose ps
      prologue:
        commands:
          - checkout
          - mkdir output
          - cd output
          - cache restore dotnet-cache
          - sudo snap install dotnet-sdk --classic
          - sudo snap install dotnet-runtime-31
          - sudo snap alias dotnet-sdk.dotnet dotnet
